#!/usr/bin/env fish

# Original https://github.com/ThePrimeagen/.dotfiles/blob/master/bin/.local/bin/tmux-sessionizer
# FZF_DEFAULT_OPTS is automatically available from Fish universal variables

# Config file and default paths
set config_file "$HOME/.config/tmux-sessionizer/config"
set default_paths "$HOME" "$HOME/.config" "$HOME/.dotfiles"

# Function to read paths from config
function read_paths
    set -l paths

    if test -f "$config_file"
        while read -l line
            # Skip empty lines and comments
            test -z "$line"; and continue
            string match -q '#*' "$line"; and continue
            # Expand ~ to $HOME
            set line (string replace '~' "$HOME" "$line")
            # Only add if directory exists
            test -d "$line"; and set -a paths "$line"
        end < "$config_file"
    end

    # Use defaults if no valid paths found
    if test (count $paths) -eq 0
        set paths $default_paths
    end

    printf '%s\n' $paths
end

# Main logic
if test (count $argv) -eq 1
    set selected $argv[1]
else
    set selected (find (read_paths) -mindepth 1 -maxdepth 1 -type d 2>/dev/null | fzf)
end

if test -z "$selected"
    exit 0
end

set selected_name (basename "$selected" | tr . _)
set tmux_running (pgrep tmux)

if test -z "$TMUX"; and test -z "$tmux_running"
    tmux new-session -s $selected_name -c $selected
    exit 0
end

if not tmux has-session -t=$selected_name 2>/dev/null
    tmux new-session -ds $selected_name -c $selected
end

tmux switch-client -t $selected_name
